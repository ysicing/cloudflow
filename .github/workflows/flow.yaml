name: install
on:
  push:
    branches:
      - master
    paths:
      - '**.go'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: install kind
        uses: helm/kind-action@v1.3.0
      - name: install kubectl
        uses: azure/setup-kubectl@v3.0
      - name: install helm
        uses: azure/setup-helm@v3
      - name: Install Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.19.x
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ github.repository_owner }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: Cache Go Dependencies
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go
          restore-keys: ${{ runner.os }}-go
      - name: Install GoTools
        run: |
          go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.46.2
          go install github.com/google/addlicense@latest
          go install golang.org/x/tools/cmd/goimports@latest
      - name: build
        run: |
          make kustomize
          make controller-gen
          make crd
          make local
      - uses: peter-evans/create-pull-request@v4
        with:
          title: 'feat(update): updated dev yaml'
          commit-message: 'update dev yaml'
          branch: create-pull-request/dev
          signoff: true
      - name: Install CloudFlow Operator
        run: |
          kubectl create namespace cce-system
          kubectl apply -f hack/deploy/deploy.yaml
          kubectl get pods -n cce-system
          kubectl apply -f config/samples/apps_v1beta1_web.yaml
          kubectl apply -f config/samples/web

